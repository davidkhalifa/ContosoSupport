# Chapter 6: Cosmos DB Implementation

In the previous chapter, [Assignment Logic/Validator](05_assignment_logic_validator.md), we learned how the system validates support ticket assignments. This chapter explains how we use Azure Cosmos DB to store and retrieve our [Support Cases](01_support_case.md) and [Support Persons](02_support_person.md).  Think of Cosmos DB as a highly scalable and globally distributed database, perfect for storing and accessing data quickly.

## What Problem Does the Cosmos DB Implementation Solve?

Imagine we have thousands of customers submitting support tickets every day. We need a database that can handle this volume of data efficiently.  Cosmos DB allows us to store and retrieve support ticket information quickly, even with massive amounts of data.

## Understanding the Cosmos DB Implementation

In `ContosoAdsSupport`, we use two main classes to interact with Cosmos DB:

- `SupportServiceCosmosDb`: This class implements the [ISupportService](03_isupportservice.md) interface and handles storing and retrieving [Support Cases](01_support_case.md).
- `SupportPersonServiceCosmosDb`: This class implements the [ISupportPersonService](04_isupportpersonservice.md) interface and manages [Support Person](02_support_person.md) data.

Both these classes use the MongoDB driver to communicate with Cosmos DB.

## Using the Cosmos DB Implementation

Let's say we want to create a new [Support Case](01_support_case.md).  Here's a simplified example using `SupportServiceCosmosDb`:

```csharp
// ... assuming supportService is an instance of SupportServiceCosmosDb

var newCase = new SupportCase { Title = "Login Issue", /* ... other properties */ };
await supportService.CreateAsync(newCase);
```

This code inserts the `newCase` into the Cosmos DB collection named "SupportCases".

Now, let's retrieve a Support Person by their alias using `SupportPersonServiceCosmosDb`:

```csharp
// ... assuming supportPersonService is an instance of SupportPersonServiceCosmosDb

var supportPerson = await supportPersonService.GetAsync("alice.wonderland");
```

This code retrieves the Support Person with the alias "alice.wonderland" from the "SupportPersons" collection in Cosmos DB.

## Internal Implementation

When we call `CreateAsync` on `SupportServiceCosmosDb`, the following steps occur:

```mermaid
sequenceDiagram
    participant Controller as SupportCasesController
    participant Service as SupportServiceCosmosDb
    participant Driver as MongoDB Driver
    participant CosmosDB as Cosmos DB

    Controller->>Service: CreateAsync(newCase)
    activate Service
    Service->>Driver: InsertOneAsync(newCase)
    activate Driver
    Driver->>CosmosDB: Insert document
    deactivate CosmosDB
    Driver-->>Service: Success/Failure
    deactivate Driver
    Service-->>Controller: Success/Failure
    deactivate Service
```

Here's a simplified snippet from `SupportServiceCosmosDb.CreateAsync` (found in  `src\ContosoAdsSupport\ContosoSupport\Services\SupportServiceCosmosDb.cs`):

```csharp
// ... other code (validation, telemetry, etc.)

await supportCases.InsertOneAsync(supportCase).ConfigureAwait(false);

// ... other code
```

This uses the `InsertOneAsync` method from the MongoDB driver to insert the `supportCase` into the Cosmos DB collection.

Similarly, when retrieving a Support Person, `SupportPersonServiceCosmosDb.GetAsync` interacts with Cosmos DB:

```csharp
// ... other code (telemetry, etc.)

var result = await supportPersons.Find(sp => sp.Alias == alias && sp.IsActive).FirstOrDefaultAsync();

// ... other code
```
This code uses the MongoDB driver's `Find` and `FirstOrDefaultAsync` methods to query the "SupportPersons" collection and retrieve the matching Support Person.


## Conclusion

We learned how `ContosoAdsSupport` uses Cosmos DB to efficiently store and retrieve large amounts of data relating to [Support Cases](01_support_case.md) and [Support Persons](02_support_person.md). This implementation enables the system to handle a high volume of support tickets effectively. Next, we'll examine an alternative approach using in-memory storage in [In-Memory Implementation](07_in_memory_implementation.md).


---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)