# Chapter 5: Assignment Logic/Validator

In the previous chapter, [ISupportPersonService](04_isupportpersonservice.md), we explored how to manage Support Person data. Now, let's dive into how the system ensures that Support Cases are assigned correctly and according to business rules.  This is where the Assignment Logic/Validator comes in.

## What Problem Does the Assignment Logic/Validator Solve?

Imagine a Support Case about a complex database issue. We want to make sure it's assigned to a Support Person who actually *knows* about databases.  The Assignment Logic/Validator acts like a gatekeeper, preventing incorrect or invalid assignments. It also provides clear reasoning for why a particular Support Person was chosen or rejected.

## Understanding the Assignment Logic/Validator

The Assignment Logic/Validator performs two key tasks:

1. **Validation:**  It checks if a proposed assignment follows the business rules. For instance, it verifies that the assigned Support Person exists and is active.

2. **Reasoning:** It provides an explanation for the assignment decision. This helps understand *why* a particular Support Person was (or wasn't) chosen.

In `ContosoAdsSupport`, this logic is encapsulated in the `AssignmentValidator` class (found in `src\ContosoAdsSupport\ContosoSupport\Services\AssignmentValidator.cs`).

## Using the Assignment Logic/Validator

Let's say we want to assign Support Case "CS-123" to Support Person "alice.wonderland".  Here's a simplified example:

```csharp
// ... other code ...

string caseId = "CS-123";
string supportPersonAlias = "alice.wonderland";
string reasoning = "Alice is our database expert.";

// ... assuming assignmentValidator is an instance of AssignmentValidator

assignmentValidator.ValidateAssignment(caseId, supportPersonAlias);
assignmentValidator.ValidateReasoning(reasoning);

// ... code to update the Support Case with the assignment ... 
```

This code uses the `ValidateAssignment` method to check if "alice.wonderland" can be assigned to "CS-123".  It also validates the provided `reasoning` using `ValidateReasoning`. If any rule is violated, a `ValidationException` is thrown.

## Internal Implementation

When a [Support Case](01_support_case.md) is created or updated with an assigned Support Person, the `SupportServiceCosmosDb` (found in `src\ContosoAdsSupport\ContosoSupport\Services\SupportServiceCosmosDb.cs`) calls the `AssignmentValidator`.

Let's visualize this with a sequence diagram:

```mermaid
sequenceDiagram
    participant Controller as SupportCasesController
    participant Service as SupportServiceCosmosDb
    participant Validator as AssignmentValidator
    participant PersonService as ISupportPersonService
    participant DB as Database

    Controller->>Service: UpdateAsync(caseId, updatedCase)
    activate Service
    Service->>Validator: ValidateAssignment(caseId, supportPersonAlias)
    activate Validator
    Validator->>PersonService: ExistsAsync(supportPersonAlias)
    Validator->>PersonService: GetAsync(supportPersonAlias)
    deactivate PersonService
    deactivate Validator
    Service->>DB: Update Support Case in Database
    deactivate Service
    Controller-->>Client: Confirmation
```

Here's a simplified snippet from `SupportServiceCosmosDb.UpdateAsync`:

```csharp
// ... other code ...

// Validate assignment before updating per FR-006
assignmentValidator.ValidateAssignment(id, supportCase.AssignedSupportPerson);
assignmentValidator.ValidateReasoning(supportCase.SupportPersonAssignmentReasoning);

// ... other code ...

```

This code shows how `ValidateAssignment` is called before updating the Support Case in the database.

Here's a simplified snippet from `AssignmentValidator.ValidateAssignment`:


```csharp
// ... other code ...

// BR-001, BR-006, BR-007: Support person must exist and be active
if (!SupportPersonExists(supportPersonAlias) || !IsActive(supportPersonAlias))
{
    throw new ValidationException("INVALID_SUPPORT_PERSON",  /* ... other parameters */);
}

// ... other code ...

```

This snippet shows how the validator checks if the Support Person exists and is active using the [ISupportPersonService](04_isupportpersonservice.md).


## Conclusion

We've learned how the Assignment Logic/Validator ensures data integrity and provides transparency in the assignment process. This helps ensure that Support Cases are handled by the most appropriate Support Persons. In the next chapter, [Cosmos DB Implementation](06_cosmos_db_implementation.md), we'll explore how Support Cases are stored and managed in a Cosmos DB database.


---

Generated by [AI Codebase Knowledge Builder](https://github.com/The-Pocket/Tutorial-Codebase-Knowledge)